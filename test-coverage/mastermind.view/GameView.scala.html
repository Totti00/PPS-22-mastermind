<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameView.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">mastermind.view</a> &gt; <span class="el_source">GameView.scala</span></div><h1>GameView.scala</h1><pre class="source lang-java linenums">package mastermind.view

import javafx.event.EventHandler
import javafx.fxml.{FXML, Initializable}
import javafx.scene.control.Label
import javafx.scene.layout.{GridPane, VBox}
import mastermind.controller.ControllerModule
import mastermind.model.{InGame, PlayerLose, PlayerWin}
import mastermind.model.entity.{HintStone, HintStones, PlayableStones, PlayerStone, Stone}
import mastermind.utils.{GridUpdateType, Initialize, UpdateHint, UpdatePlayable}
import scalafx.animation.{KeyFrame, Timeline}
import scalafx.scene.image.{Image, ImageView}
import scalafx.util.Duration
import scalafx.Includes.*
import scalafx.scene.{ImageCursor, Scene}
import scalafx.scene.input.ScrollEvent
import scalafx.stage.Stage
import mastermind.model.entity.PlayerStone.Playable
import mastermind.utils.PagesEnum.Rules
import java.net.URL
import java.util.ResourceBundle
import scala.jdk.CollectionConverters.*
import java.text.{DateFormat, SimpleDateFormat}
import mastermind.utils.ErrorHandler.*

trait GameView:
  /** Handles the action for the check button, submitting the current guess.
    */
  def checkButton(): Unit

  /** Handles the action for the reset button, resetting the game.
    */
  def resetButton(): Unit

  /** Handles the action for the back button, returning to the main menu.
    */
  def backButton(): Unit

  /** Handles the action for the help button, displaying the rules.
    */
  def helpButton(): Unit

  /** Updates the view based on the given update type.
    * @param updateType
    *   The type of update to perform.
    * @param hintStones
    *   The hint stones to update the hint grid with.
    */
  def updateView(updateType: GridUpdateType, hintStones: Option[HintStones]): Unit

<span class="nc" id="L51">object GameView:</span>
<span class="fc" id="L52">  def apply(controller: ControllerModule.Controller, stage: Stage): GameView = GameViewImpl(controller, stage)</span>
<span class="pc" id="L53">  private class GameViewImpl(private val controller: ControllerModule.Controller, private val stage: Stage)</span>
      extends GameView
      with Initializable:

    // noinspection VarCouldBeVal
    @FXML
    private var resultGame: Label = _

    // noinspection VarCouldBeVal
    @FXML
    private var attemptGrid: GridPane = _

    // noinspection VarCouldBeVal
    @FXML
    private var hintGrid: GridPane = _

    // noinspection VarCouldBeVal
    @FXML
    private var timeLabel: Label = _

    // noinspection VarCouldBeVal
    @FXML
    private var turnsLabel: Label = _

    // noinspection VarCouldBeVal
    @FXML
    private var mainContainer: VBox = _

<span class="fc" id="L81">    private var timer: Option[Timeline] = None</span>
<span class="fc" id="L82">    private var browseColors: Int = 0</span>
<span class="fc" id="L83">    private var selectableColors: Option[PlayableStones] = None</span>

    /** This method is called after the FXML view is loaded.
      *
      * @param location
      *   The URL of the FXML file.
      * @param resourceBundle
      *   The resource bundle used for localization.
      */
    override def initialize(location: URL, resourceBundle: ResourceBundle): Unit =
<span class="nc" id="L93">      updateView(Initialize)</span>
<span class="nc" id="L94">      stage.scene = new Scene(mainContainer)</span>
<span class="nc" id="L95">      setCustomCursor(stage.scene.get())</span>
<span class="nc" id="L96">      setupScrollHandler(stage.scene.get())</span>
<span class="nc" id="L97">      setLabelText(turnsLabel, s&quot;Remaining Turns: ${controller.remainingTurns}&quot;)</span>
<span class="nc" id="L98">      stage.sizeToScene()</span>
<span class="nc" id="L99">      stage.title = &quot;Mastermind&quot;</span>
<span class="nc" id="L100">      stage.show()</span>

<span class="nc" id="L102">    override def checkButton(): Unit = submitGuess()</span>

<span class="fc" id="L104">    override def resetButton(): Unit = controller.resetGame()</span>

<span class="fc" id="L106">    override def backButton(): Unit = controller.backToMenu()</span>

<span class="fc" id="L108">    override def helpButton(): Unit = controller.goToPage(Rules)</span>

<span class="nc" id="L110">    override def updateView(updateType: GridUpdateType, hintStones: Option[HintStones] = None): Unit =</span>
<span class="nc" id="L111">      updateRemainingTurns()</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">      val (rows, cols) = controller.getSizeBoard</span>
<span class="nc" id="L113">      controller.gameState match</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">        case PlayerWin =&gt;</span>
<span class="nc" id="L115">          timer.get.stop()</span>
<span class="nc" id="L116">          setLabelText(resultGame, &quot;You Win!&quot;)</span>
<span class="nc" id="L117">          fillGrid(rows, cols)</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        case PlayerLose =&gt;</span>
<span class="nc" id="L119">          timer.get.stop()</span>
<span class="nc" id="L120">          setLabelText(resultGame, &quot;You Lose!&quot;)</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        case InGame =&gt;</span>
<span class="nc" id="L122">          updateType match</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            case Initialize =&gt;</span>
<span class="nc" id="L124">              attemptGrid.getChildren.clear()</span>
<span class="nc" id="L125">              hintGrid.getChildren.clear()</span>
<span class="nc" id="L126">              initializeTime(timeLabel)</span>
<span class="nc" id="L127">              setLabelText(resultGame, &quot;&quot;)</span>
<span class="nc" id="L128">              fillGrid(rows, cols)</span>
<span class="nc" id="L129">              setCustomCursor(stage.scene.get())</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            case UpdateHint =&gt;</span>
<span class="nc" id="L131">              updateGrid(hintGrid, hintStones.getOrElse(Vector.empty), getGraphicLabel)</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            case UpdatePlayable =&gt;</span>
<span class="nc" id="L133">              val newCurrentTurnStones = (for (i &lt;- 0 until cols) yield getStone(i, controller.turn)).toVector</span>
<span class="nc" id="L134">              updateGrid(attemptGrid, newCurrentTurnStones, identity)</span>

    private def updateRemainingTurns(): Unit =
<span class="nc" id="L137">      setLabelText(turnsLabel, s&quot;Remaining Turns: ${controller.remainingTurns}&quot;)</span>

    private def updateGrid[T](grid: GridPane, newValues: Vector[T], labelTransformer: T =&gt; Label): Unit =
<span class="nc" id="L140">      grid.getChildren.asScala</span>
<span class="nc bnc" id="L141" title="All 18 branches missed.">        .collect { case label: Label if GridPane.getRowIndex(label) == controller.turn =&gt; label }</span>
<span class="nc" id="L142">        .zip(newValues)</span>
<span class="nc" id="L143">        .foreach { case (label, newValue) =&gt;</span>
          val newLabel = labelTransformer(newValue)
          label.setGraphic(newLabel.getGraphic)
          label.setText(newLabel.getText)
        }

    private def initializeTime(timeLabel: Label): Unit =
<span class="nc bnc" id="L150" title="All 2 branches missed.">      if timer.isDefined then timer.get.stop()</span>
<span class="nc" id="L151">      setLabelText(timeLabel, &quot;Time: 00:00&quot;)</span>
<span class="nc" id="L152">      val startTime = System.currentTimeMillis()</span>
<span class="nc" id="L153">      val timeFormat: DateFormat = new SimpleDateFormat(&quot;mm:ss&quot;)</span>
<span class="nc" id="L154">      timer = Some(</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        new Timeline:</span>
<span class="nc" id="L156">          cycleCount = Timeline.Indefinite</span>
<span class="nc" id="L157">          keyFrames = Seq(</span>
<span class="nc" id="L158">            KeyFrame(</span>
<span class="nc" id="L159">              Duration(1000),</span>
<span class="nc" id="L160">              onFinished = () =&gt;</span>
                val diff = System.currentTimeMillis() - startTime
                setLabelText(timeLabel, s&quot;Time: ${timeFormat.format(diff)}&quot;)
<span class="nc" id="L163">            )</span>
<span class="nc" id="L164">          )</span>
      )
<span class="nc" id="L166">      timer.get.play()</span>

    private def getGraphicLabel(hintStone: HintStone): Label =
<span class="nc" id="L169">      val label = new Label(hintStone.toString)</span>
<span class="nc" id="L170">      label.setGraphic(getGraphic(hintStone))</span>
<span class="nc" id="L171">      label</span>

    private def getGraphic(stone: Stone): ImageView =
      val urlStone =
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if stone.isInstanceOf[HintStone] then s&quot;/img/hintStones/hstone_${stone.toString}.png&quot;</span>
<span class="nc" id="L176">        else s&quot;/img/stones/stone_${stone.toString}.png&quot;</span>
<span class="nc" id="L177">      val circle_size = 60</span>
<span class="nc" id="L178">      val image_size = circle_size - 5</span>
<span class="nc" id="L179">      new ImageView(new Image(getClass.getResource(urlStone).toExternalForm, image_size, image_size, true, true))</span>

    private def setLabelText(label: Label, text: String): Unit =
<span class="nc" id="L182">      label.setText(text)</span>

    private def fillGrid(rows: Int, cols: Int): Unit =
<span class="nc" id="L185">      for c &lt;- 0 until cols; r &lt;- 0 until rows do</span>
        attemptGrid.add(getStone(c, r), c, r)
        hintGrid.add(getHint(c, r), c, r)

<span class="nc" id="L189">    private def getStone(c: Int, r: Int): Label = createStoneLabel(c, r, &quot;playable&quot;)</span>

<span class="nc" id="L191">    private def getHint(c: Int, r: Int): Label = createStoneLabel(c, r, &quot;hint&quot;)</span>

    private def createStoneLabel(c: Int, r: Int, stoneType: String): Label =
<span class="nc" id="L194">      controller.getStone(r, c, stoneType) match</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        case Right(stone) =&gt;</span>
<span class="nc" id="L196">          val label = new Label(stone.toString)</span>
<span class="nc" id="L197">          configureLabel(label)</span>
<span class="nc" id="L198">          label.setGraphic(getGraphic(stone))</span>
<span class="nc" id="L199">          label.setOnMouseClicked { _ =&gt;</span>
            if controller.turn == r &amp;&amp; stoneType == &quot;playable&quot; then
              label.setGraphic(
                new ImageView(
                  new Image(
                    getClass.getResource(s&quot;/img/stones/stone_${selectableColors.get(browseColors)}.png&quot;).toExternalForm,
                    55,
                    55,
                    true,
                    true
                  )
                )
              )
              label.setText(selectableColors.get(browseColors).toString)
          }
<span class="nc" id="L214">          label</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        case Left(_) =&gt;</span>
<span class="nc" id="L216">          val label = new Label(&quot;Invalid stone type&quot;)</span>
<span class="nc" id="L217">          configureLabel(label)</span>
<span class="nc" id="L218">          setLabelText(resultGame, &quot;Stone Type Error !&quot;)</span>
<span class="nc" id="L219">          label</span>

    private def configureLabel(label: Label): Label =
<span class="nc" id="L222">      label.setPrefSize(60, 60)</span>
<span class="nc" id="L223">      label.setMinSize(60, 60)</span>
<span class="nc" id="L224">      label.setMaxSize(60, 60)</span>
<span class="nc" id="L225">      label</span>

    private def setupScrollHandler(scene: Scene): Unit =
<span class="nc" id="L228">      scene.addEventHandler(</span>
<span class="nc" id="L229">        ScrollEvent.Scroll,</span>
<span class="nc" id="L230">        (event: ScrollEvent) =&gt;</span>
          if math.abs(event.deltaY) &gt;= 2 then
            if event.deltaY &lt; 0 then browseColors = (browseColors + 1) % selectableColors.get.length
            else if event.deltaY &gt; 0 then
              browseColors = (browseColors - 1 + selectableColors.get.length) % selectableColors.get.length
<span class="nc" id="L235">          setCustomCursor(scene)</span>
      )

    private def setCustomCursor(scene: Scene): Unit =
<span class="nc" id="L239">      selectableColors = Some(controller.colors)</span>
<span class="nc" id="L240">      scene.setCursor(</span>
<span class="nc" id="L241">        new ImageCursor(</span>
<span class="nc" id="L242">          new Image(</span>
<span class="nc" id="L243">            getClass.getResource(s&quot;/img/coursers/courser_${selectableColors.get(browseColors)}.png&quot;).toExternalForm,</span>
<span class="nc" id="L244">            32,</span>
<span class="nc" id="L245">            32,</span>
<span class="nc" id="L246">            true,</span>
<span class="nc" id="L247">            true</span>
          )
        )
      )

    private def submitGuess(): Unit =
<span class="pc bpc" id="L253" title="4 of 6 branches missed.">      if controller.gameState == InGame then</span>
<span class="nc" id="L254">        val guess = extractGuess()</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if !guess.contains(Playable) then controller.checkCode(guess)</span>

    private def extractGuess(): PlayableStones =
<span class="pc" id="L258">      attemptGrid.getChildren</span>
<span class="nc" id="L259">        .filtered(child =&gt; GridPane.getRowIndex(child) == controller.turn)</span>
        .asScala
<span class="nc" id="L261">        .map(cell =&gt; PlayerStone.fromString(cell.asInstanceOf[Label].getText))</span>
        .toVector
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>